
.PHONY: build run test
.DEFAULT: build
.SUBDIRS: pa


USE_OCAMLFIND= true
BYTE_ENABLED= false
NATIVE_ENABLED= true
OCAMLFLAGS += -g -dtypes -warn-error A
cmo = $(file pa/pa_partoches.cmo)

build : $(cmo)

OCamlGeneratedFiles($(cmo))

OCAMLPACKS[]=
	extlib
	json-wheel
	lwt
	eliom
	tyxml
	eliom.server

OCAMLFLAGS+= -thread
OCAMLFLAGS += -pp 'camlp4o $(cmo)' 
OCAMLOPTFLAGS+= 
OCAML_NATIVE_LINK_FLAGS += -pp 'camlp4o $(cmo)'
OCAMLDEPFLAGS +=  -ppopt pa_extend.cmo -ppopt q_MLast.cmo 
CAMLP4 = camlp4

ocamlfind ocamlopt $(file pa_exn.mli) -o pa_exn.cmi -package extlib

# ATTENTION: la compilation avec eliomopt n'est pas supportee par omake,
# donc : pas de deps, et pas d'ordre gere
# mettre l'ordre correct manuellement
src-core[]=
	pa_exn
	version
	util
	note
	instrument
	bar
	part
	score
	song	

src-server[]=
	main


version.ml : ../OInstall/version.ml 
	cp $< $@

ELIOMOPT = eliomopt -I ../ -warn-error A -I $(shell ocamlfind query json-wheel) 	-I $(shell ocamlfind query extlib) 

cmxs = $(addsuffix .cmx,$(src-core) $(src-server))
cmis = $(addsuffix .cmi,$(src-core) $(src-server))

partoches.cmxs : $(cmxs) $(cmis)
	$(ELIOMOPT) -shared -o $@ $(cmxs)


partoches = $(OCamlProgram partoches,pa_exn version util launcher)

install(bin,partoches.cmxs)
install(bin,partoches)
install(staticdir/css,partoches.css upload.css upload2.css filedrag.css)
install(staticdir/js,upload.js filedrag.js)

build : $(OCamlLibrary partoches-core,$(file $(src-core)))

