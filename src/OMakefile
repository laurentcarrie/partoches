
.PHONY: build run test
.DEFAULT: build
.SUBDIRS: pa 3rdparty


USE_OCAMLFIND= true
BYTE_ENABLED= false
NATIVE_ENABLED= true
OCAMLFLAGS += -g -dtypes -warn-error A
cmo = $(file pa/pa_partoches.cmo)

build : $(cmo)

OCamlGeneratedFiles($(cmo))

OCAMLPACKS[]=
	extlib
	json-wheel
	lwt
	eliom
	tyxml
	eliom.server

OCAMLFLAGS+= -thread
OCAMLFLAGS += -pp 'camlp4o $(cmo)' 
OCAMLOPTFLAGS+= 
OCAML_NATIVE_LINK_FLAGS += -pp 'camlp4o $(cmo)'
OCAMLDEPFLAGS +=  -ppopt pa_extend.cmo -ppopt q_MLast.cmo 
CAMLP4 = camlp4

ocamlfind ocamlopt $(file pa_exn.mli) -o pa_exn.cmi -package extlib

# ATTENTION: la compilation avec eliomopt n'est pas supportee par omake,
# donc : pas de deps, et pas d'ordre gere
# mettre l'ordre correct manuellement
src-core[]=
	pa_exn
	version
	util
	note
	instrument
	bar
	part
	score
	song	

src-server[]=
	menu
	main
	voir
	editer


version.ml : ../OInstall/version.ml 
	cp $< $@

ELIOMOPT = eliomopt -I ../ -warn-error A -I $(shell ocamlfind query json-wheel) 	-I $(shell ocamlfind query extlib) 

cmxs = $(addsuffix .cmx,$(src-core) $(src-server))
cmis = $(addsuffix .cmi,$(src-core) $(src-server))

partoches.cmxs : $(cmxs) $(cmis)
	$(ELIOMOPT) -shared -o $@ $(cmxs)


partoches = $(OCamlProgram partoches,pa_exn version util launcher)

install(bin,partoches.cmxs)
install(bin,partoches)

css-files[]=
	partoches
	upload
	upload2
	filedrag
	jquery-ui-1.8.17.custom
	ui.dynatree
	menu

css-files=$(addsuffix .css,$(css-files))

gif-files[]=
	icons
	loading
	vline

install(staticdir/css,$(css-files))
install(staticdir/js,upload.js filedrag.js editer.js jquery-1.7.1.min.js  jquery.dynatree.min.js  jquery-ui-1.8.17.custom.min.js )
install(staticdir/css,$(addprefix skin/,$(addsuffix .gif,$(gif-files))))

build : $(OCamlLibrary partoches-core,$(file $(src-core)))

install(staticdir/3rdparty/slate,slate-generated.css)